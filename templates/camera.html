<!doctype html>
<html>
<head>
    <title>Photo Manager</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>Photo Manager</h1>
    <p>Current Session: {{ session_name }}</p>
    <button onclick="window.location.href='/logout'">Logout</button>
    <br/><br/>

    <form action="/new_session" method="post">
        <input type="text" name="session_name" placeholder="Session Name">
        <button type="submit">New Session</button>
    </form>
    <br/>

    <div id="video-container">
        <video id="video" width="640" height="480" autoplay></video><br/>
    </div>

    <div id="controls">
        <button id="snap">Capture Photo</button>
        <br/><br/>

        <!-- Controls for automatic photo capture -->
        <label for="interval">Capture every N milliseconds:</label>
        <input type="number" id="interval" value="1000" min="100" step="100">
        <button id="start-auto">Start Auto Capture</button>
        <button id="stop-auto" disabled>Stop Auto Capture</button>
        <br/><br/>

        <!-- Upload photos from local machine -->
        <form action="/upload_photo" method="post" enctype="multipart/form-data">
            <input type="file" name="files[]" accept="image/*" multiple>
            <button type="submit">Upload Photos</button>
        </form>
    </div>

    <!-- Combined container for displaying current session photos -->
    <div class="session-photos">
        <h2>Current Session Photos</h2>
        <form id="current-session-form" action="" method="post">
            <div class="photo-grid">
                {% for filename in current_photos %}
                <div class="photo-wrapper" data-filename="{{ filename }}">
                    <img src="{{ url_for('uploaded_file', username=session['username'], session_name=session_name, filename=filename) }}" alt="Photo">
                    <input type="checkbox" name="selected_photos[]" value="{{ filename }}" class="photo-checkbox">
                </div>
                {% endfor %}
            </div>
            <button type="button" onclick="downloadSelectedPhotos('{{ session_name }}')">Download Selected Photos</button>
        </form>
    </div>

    <!-- Display previous sessions -->
    <div class="previous-sessions">
        <h2>Previous Sessions</h2>
        <div class="sessions-list">
            {% for sess in sessions %}
            <div class="session">
                <h3>{{ sess.name }}</h3>
                <form class="session-form" action="" method="post">
                    <div class="photo-grid">
                        {% for filename in sess.photos %}
                        <div class="photo-wrapper" data-filename="{{ filename }}">
                            <img src="{{ url_for('uploaded_file', username=session['username'], session_name=sess.name, filename=filename) }}" alt="Photo">
                            <input type="checkbox" name="selected_photos[]" value="{{ filename }}" class="photo-checkbox">
                        </div>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="session_name" value="{{ sess.name }}">
                    <button type="button" onclick="downloadSelectedPhotos('{{ sess.name }}')">Download Selected Photos</button>
                    <button type="button" onclick="addSelectedPhotosToCurrentSession('{{ sess.name }}')">Add Selected to Current Session</button>
                </form>
                <!-- Add Delete Session Button -->
                <form action="/delete_session" method="post" onsubmit="return confirm('Are you sure you want to delete this session? This action cannot be undone.');">
                    <input type="hidden" name="session_name" value="{{ sess.name }}">
                    <button type="submit" class="delete-button">Delete Session</button>
                </form>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Hidden canvas -->
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');

        // Request access to the webcam
        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => { video.srcObject = stream; })
                .catch(err => { console.error("Error accessing webcam: " + err); });
        }

        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const snap = document.getElementById('snap');
        let autoCaptureInterval = null;

        function capturePhoto() {
            context.drawImage(video, 0, 0, 640, 480);
            const dataURL = canvas.toDataURL('image/png');

            // Display the photo in the container
            const img = document.createElement('img');
            img.src = dataURL;
            img.alt = 'Photo';

            const photoWrapper = document.createElement('div');
            photoWrapper.classList.add('photo-wrapper');
            photoWrapper.dataset.filename = ''; // Since it's not saved yet
            photoWrapper.appendChild(img);

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = 'selected_photos[]';
            checkbox.classList.add('photo-checkbox');
            photoWrapper.appendChild(checkbox);

            const photoGrid = document.querySelector('.session-photos .photo-grid');
            photoGrid.appendChild(photoWrapper);

            // Send the image data to the server
            fetch('/upload_photo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'image=' + encodeURIComponent(dataURL)
            })
            .then(response => response.text())
            .then(data => {
                if (data !== 'Photo saved successfully') {
                    console.error('Server error:', data);
                    // Optionally, remove the photo from the UI or indicate an error
                    // photoGrid.removeChild(photoWrapper);
                    alert('Failed to save photo on server.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Handle network errors
                photoGrid.removeChild(photoWrapper);
                alert('Network error occurred while saving the photo.');
            });
        }

        snap.addEventListener('click', capturePhoto);

        // Automatic photo capture
        const startAutoBtn = document.getElementById('start-auto');
        const stopAutoBtn = document.getElementById('stop-auto');
        const intervalInput = document.getElementById('interval');

        startAutoBtn.addEventListener('click', () => {
            const interval = parseInt(intervalInput.value);
            if (isNaN(interval) || interval < 100) {
                alert('Please enter a valid interval (minimum 100 milliseconds).');
                return;
            }
            startAutoBtn.disabled = true;
            stopAutoBtn.disabled = false;
            intervalInput.disabled = true;

            autoCaptureInterval = setInterval(capturePhoto, interval);
        });

        stopAutoBtn.addEventListener('click', () => {
            clearInterval(autoCaptureInterval);
            startAutoBtn.disabled = false;
            stopAutoBtn.disabled = true;
            intervalInput.disabled = false;
        });

        // Photo selection by clicking on the photo
        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'IMG' && e.target.parentElement.classList.contains('photo-wrapper')) {
                const checkbox = e.target.parentElement.querySelector('.photo-checkbox');
                checkbox.checked = !checkbox.checked;
                e.target.parentElement.classList.toggle('selected', checkbox.checked);
            }
        });

        // Download selected photos
        function downloadSelectedPhotos(sessionName) {
            const form = event.target.closest('form');
            const selectedPhotos = Array.from(form.querySelectorAll('.photo-checkbox:checked')).map(cb => cb.value);
            if (selectedPhotos.length === 0) {
                alert('Please select at least one photo.');
                return;
            }
            const formData = new FormData();
            selectedPhotos.forEach(photo => formData.append('selected_photos[]', photo));
            formData.append('session_name', sessionName);
            fetch('/download_photos', {
                method: 'POST',
                body: formData
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${sessionName}_photos.zip`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            })
            .catch(error => { console.error('Error:', error); });
        }

        // Add selected photos to current session
        function addSelectedPhotosToCurrentSession(sessionName) {
            const form = event.target.closest('form');
            const selectedPhotos = Array.from(form.querySelectorAll('.photo-checkbox:checked')).map(cb => cb.value);
            if (selectedPhotos.length === 0) {
                alert('Please select at least one photo.');
                return;
            }
            const formData = new FormData();
            selectedPhotos.forEach(photo => formData.append('selected_photos[]', photo));
            formData.append('session_name', sessionName);
            fetch('/add_photos_to_current_session', {
                method: 'POST',
                body: formData
            })
            .then(() => {
                window.location.reload();
            })
            .catch(error => { console.error('Error:', error); });
        }

    </script>
</body>
</html>
