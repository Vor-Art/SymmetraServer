<!doctype html>
<html>
<head>
    <title>Take a Photo</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>Take a Photo</h1>
    <p>Current Session: {{ session_name }}</p>
    <button onclick="window.location.href='/logout'">Logout</button>
    <br/><br/>

    <form action="/new_session" method="post">
        <input type="text" name="session_name" placeholder="Session Name">
        <button type="submit">New Session</button>
    </form>
    <br/>

    <div id="video-container">
        <video id="video" width="640" height="480" autoplay></video><br/>
    </div>

    <div id="controls">
        <button id="snap">Capture Photo</button>
        <br/><br/>

        <!-- Controls for automatic photo capture -->
        <label for="interval">Capture every N milliseconds:</label>
        <input type="number" id="interval" value="1000" min="100" step="100">
        <button id="start-auto">Start Auto Capture</button>
        <button id="stop-auto" disabled>Stop Auto Capture</button>
        <br/><br/>

        <!-- Upload photo from local machine -->
        <form action="/upload_photo" method="post" enctype="multipart/form-data">
            <input type="file" name="file" accept="image/*">
            <button type="submit">Upload Photo</button>
        </form>
    </div>

    <!-- Scrollable container for displaying photos -->
    <div id="photo-container"></div>

    <!-- Display photos from current session -->
    <div class="session-photos">
        <h2>Photos in Current Session</h2>
        {% for filename in current_photos %}
        <div class="photo-wrapper">
            <img src="{{ url_for('uploaded_file', username=session['username'], session_name=session_name, filename=filename) }}" alt="Photo">
            <a href="{{ url_for('download_photo', session_name=session_name, filename=filename) }}" class="download-link">Download</a>
        </div>
        {% endfor %}
    </div>

    <!-- Display previous sessions -->
    <div class="session-photos">
        <h2>Previous Sessions</h2>
        {% for sess_name, files in sessions %}
            {% if sess_name != session_name %}
            <h3>{{ sess_name }}</h3>
            {% for file in files %}
            <div class="photo-wrapper">
                <img src="{{ url_for('uploaded_file', username=session['username'], session_name=sess_name, filename=file) }}" alt="Photo">
                <a href="{{ url_for('download_photo', session_name=sess_name, filename=file) }}" class="download-link">Download</a>
                <!-- Form to add photo to current session -->
                <form action="/add_previous_photo" method="post" style="display:inline;">
                    <input type="hidden" name="session_name" value="{{ sess_name }}">
                    <input type="hidden" name="filename" value="{{ file }}">
                    <button type="submit">Add to Current Session</button>
                </form>
            </div>
            {% endfor %}
            {% endif %}
        {% endfor %}
    </div>

    <!-- Hidden canvas -->
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');

        // Request access to the webcam
        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => { video.srcObject = stream; })
                .catch(err => { console.error("Error accessing webcam: " + err); });
        }

        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const snap = document.getElementById('snap');
        const photoContainer = document.getElementById('photo-container');
        let autoCaptureInterval = null;

        function capturePhoto() {
            context.drawImage(video, 0, 0, 640, 480);
            const dataURL = canvas.toDataURL('image/png');

            // Display the photo in the container
            const img = document.createElement('img');
            img.src = dataURL;
            photoContainer.appendChild(img);

            // Send the image data to the server
            fetch('/upload_photo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'image=' + encodeURIComponent(dataURL)
            })
            .catch(error => { console.error('Error:', error); });
        }

        snap.addEventListener('click', capturePhoto);

        // Automatic photo capture
        const startAutoBtn = document.getElementById('start-auto');
        const stopAutoBtn = document.getElementById('stop-auto');
        const intervalInput = document.getElementById('interval');

        startAutoBtn.addEventListener('click', () => {
            const interval = parseInt(intervalInput.value);
            if (isNaN(interval) || interval < 100) {
                alert('Please enter a valid interval (minimum 100 milliseconds).');
                return;
            }
            startAutoBtn.disabled = true;
            stopAutoBtn.disabled = false;
            intervalInput.disabled = true;

            autoCaptureInterval = setInterval(capturePhoto, interval);
        });

        stopAutoBtn.addEventListener('click', () => {
            clearInterval(autoCaptureInterval);
            startAutoBtn.disabled = false;
            stopAutoBtn.disabled = true;
            intervalInput.disabled = false;
        });
    </script>
</body>
</html>
